---
title: "Facteurs explicatifs de la variable dépendante"
subtitle: "Modèle linéaire (LM), validité et post-hoc"
---

::: callout-important
## Objectif du chapitre

Identifier **quels facteurs** (groupe, variété, période) **expliquent** la variable dépendante *taille*, en testant les effets principaux et les interactions (un facteur ; deux facteurs avec ou sans interaction), puis en réalisant les comparaisons post-hoc en cas d'effets significatifs.
:::

# Objectif

Ce chapitre vise à **déterminer les facteurs qui peuvent expliquer la variable dépendante** (la hauteur des plantes). On distingue classiquement :

-   **Un facteur** : on teste l'effet d'un seul facteur (ex. fertilisant, ou variété, ou période) sur la variable dépendante.
-   **Deux facteurs avec ou sans interaction** : on teste les effets de deux facteurs (ex. fertilisant et variété, ou fertilisant et période) et leur interaction. Si l'interaction est significative, l'effet d'un facteur dépend du niveau de l'autre ; sinon, les effets principaux suffisent à interpréter les résultats.

Dans notre étude, la variable dépendante est la **hauteur** ; les facteurs sont le **fertilisant** (terreau : Ma, Ca, An), la **variété** (Var1, Var2) et la **période** (T1–T4). Les plantes sont toutes différentes (individus uniques), avec des mesures répétées dans le temps. On utilise un **modèle linéaire (LM)** à effets fixes : **fertilisant** (principal), **variété** (contrôle) et **période** ; chaque ligne des données correspond à une observation de hauteur.

# Données et modèle linéaire (LM)

Les mêmes données qu’au chapitre 2 sont chargées puis analysées avec un modèle **hauteur \~ fertilisant × variété + Error(id / période)** : effets fixes *fertilisant* (3 terreaux), *variété* (2 variétés), *période* (T1–T4) et interactions ; effet aléatoire intercept par *plante* (id). Tous les sujets sont inclus.

## Explication de ce qui est fait dans le modèle

Voici, dans l'ordre, ce que fait le chapitre en utilisant **uniquement une ANOVA à mesures répétées avec `afex::aov_car`**.

**1. Import et préparation des données**

-   Lecture du fichier Excel `donnees/donnees.xlsx`.
-   Variables utilisées : **groupe** (terreau Ma, Ca, An), **variete** (Var1, Var2), **periode** (T1–T4), **taille** (variable à expliquer).
-   Conversion de `taille` en numérique en gérant les **virgules décimales**.
-   Mise en facteur de `groupe`, `variete`, `periode` avec les bons niveaux.
-   Création d’un identifiant **technique** `id` (une étiquette par ligne) pour définir la structure des **mesures répétées** dans le modèle (mais sans entrer comme facteur explicatif).

**2. Modèle ANOVA à mesures répétées (afex::aov_car)**

-   Le modèle est ajusté avec :
    -   **Variable dépendante (dv)** : `taille`.
    -   **Facteurs inter-sujets (between)** : `groupe` et `variete` (chaque observation appartient à une seule combinaison groupe × variété).
    -   **Facteur intra-sujet (within)** : `periode` (mêmes plantes suivies à T1, T2, T3, T4).
-   Formule utilisée :\
    \[ \text{taille} \sim \text{groupe} \times \text{variete} + \text{Error(id / periode)} \]
-   `afex::aov_car` calcule une **ANOVA de type III** avec, pour chaque effet (groupe, variete, groupe×variete, etc.) :
    -   les **sommes de carrés**,
    -   le **F** de Fisher,
    -   la **p-value**,
    -   la **taille d’effet** ((\eta\^2) partiel, `pes`).

**3. Sphéricité et corrections (Mauchly, GG, HF)**

-   `summary()` du modèle fournit :
    -   le **test de Mauchly** de sphéricité pour les effets impliquant `periode`,
    -   les **corrections de Greenhouse–Geisser (GG)** et **Huynh–Feldt (HF)** si la sphéricité n’est pas respectée.
-   L’interprétation des effets de `periode` et des interactions avec `periode` se base sur ces p-values corrigées.

**4. Vérifications des conditions de validité**

-   **Normalité des résidus** : graphiques Q–Q et histogramme des résidus de l’ANOVA à mesures répétées.
-   **Homogénéité des variances (Levene)** : test de Levene sur la **taille moyenne par combinaison groupe × variété × id**, afin de vérifier l’égalité des variances entre conditions.

**5. Comparaisons post-hoc (emmeans)**

-   **Moyennes marginales (groupe × variété)** : estimation des moyennes de `taille` pour chaque combinaison groupe–variété, avec erreurs standard et intervalles de confiance à 95 %.
-   **Comparaisons deux à deux (Tukey)** :
    -   Comparaisons entre toutes les combinaisons **groupe × variété** (effets globaux).
    -   Comparaisons **par période** : mêmes contrastes, mais séparément pour T1, T2, T3, T4, pour repérer les périodes où les différences sont significatives.

**Résumé** : cette ANOVA à mesures répétées teste si le **terreau** (`groupe`), la **variété** (`variete`) et la **période** (`periode`) – ainsi que leurs interactions – expliquent la **taille**, en respectant la structure de mesures répétées. Les diagnostics (normalité, Levene, sphéricité) justifient l’usage des tests F et des post-hoc de Tukey, qui permettent ensuite de conclure sur les conditions (terreau × variété, par période) donnant les tailles les plus élevées.

```{r ch3-libs, message=FALSE, warning=FALSE}
library(tidyverse)
library(emmeans)
library(car)
if (!requireNamespace("afex", quietly = TRUE)) install.packages("afex", repos = "https://cloud.r-project.org", quiet = TRUE)
library(afex)
if (!requireNamespace("gtsummary", quietly = TRUE)) install.packages("gtsummary", repos = "https://cloud.r-project.org", quiet = TRUE)
library(gtsummary)
library(knitr)
```

```{r ch3-import, error=TRUE}
# --- Import : plan = mesures répétées T1–T4 pour Var1 et Var2, dans chaque fertilisant ---
if (!requireNamespace("readxl", quietly = TRUE)) install.packages("readxl", repos = "https://cloud.r-project.org", quiet = TRUE)
library(readxl)
d <- read_excel("donnees/donnees.xlsx")

d$hauteur <- as.numeric(gsub(",", ".", as.character(d$hauteur)))
d <- d %>%
  mutate(
    periode     = factor(as.character(periode), levels = c("T1", "T2", "T3", "T4")),
    fertilisant = factor(fertilisant, levels = c("Ma", "Ca", "An")),
    variete     = factor(variete)
  ) %>%
  # Création d'identifiants "sujets" artificiels par (fertilisant, variete, rang)
  # pour simuler des mesures répétées comme dans l'exemple DABIRE
  group_by(fertilisant, variete, periode) %>%
  arrange(fertilisant, variete, periode, .by_group = TRUE) %>%
  mutate(rang = row_number()) %>%
  ungroup() %>%
  mutate(
    id = interaction(fertilisant, variete, rang, drop = TRUE),
    id = factor(id)
  )
```

## Description du modèle utilisé

Le modèle utilisé est une **ANOVA à mesures répétées** implémentée avec `afex::aov_car`. Chaque ligne du tableau correspond à **une observation de hauteur pour une combinaison (fertilisant, variété, période)**.

| Élément | Description |
|----|----|
| **Variable dépendante** | `hauteur` (hauteur des plantes, quantitative) |
| **Facteurs inter-sujets** | `fertilisant` (3 terreaux : Ma, Ca, An), `variete` (2 variétés) |
| **Facteur intra-sujet** | `periode` (T1–T4, mesures répétées) |
| **Identifiant (id)** | Étiquette technique construite par combinaison `(fertilisant, variete, rang)` pour regrouper artificiellement les mesures répétées dans `Error(id / periode)` |
| **Formule** | `hauteur ~ fertilisant * variete + Error(id / periode)` |
| **Options** | Type III ; corrections **Greenhouse–Geisser** / **Huynh–Feldt** pour les termes impliquant `periode` ; **η² partiel (pes)** comme taille d’effet |

```{r aov-car, error=TRUE}
# --- ANOVA à mesures répétées avec afex::aov_car -------------------------

# On fixe le type de sommes de carrés à III (classique en présence d'interactions)
afex::afex_options(type = 3)

# Ajustement du modèle :
# - hauteur : variable dépendante
# - fertilisant * variete : effets fixes inter-sujets et leur interaction
# - Error(id / periode) : structure de mesures répétées (effet de periode imbriqué dans id)
# - na.rm = TRUE : les observations manquantes (périodes non observées pour certains individus)
#   sont retirées de l'analyse, comme suggéré par le message d'erreur d'afex.
anova_rm <- afex::aov_car(
  hauteur ~ fertilisant * variete + Error(id / periode),
  data  = d,
  na.rm = TRUE
)

# Tableau ANOVA "propre" (nice) :
# - fournit F, p-value, et η² partiel (pes) pour chaque effet
tab_rm <- nice(anova_rm, es = "pes")
knitr::kable(
  tab_rm,
  caption = "ANOVA à mesures répétées (afex::aov_car) : effets de fertilisant, variété, période et interactions, avec η² partiel."
)

# Résumé complet du modèle :
# - inclut le test de Mauchly (sphéricité)
# - et les corrections GG / HF si nécessaire
summary(anova_rm)
```

En résumé, la hauteur dépend significativement du **fertilisant** et de la **variété**, ainsi que de la **période** de mesure, avec une interaction significative entre **variété et période** ; les interactions impliquant le fertilisant ne sont pas significatives.

Les tests de **Mauchly** ne sont pas significatifs, ce qui indique que l’hypothèse de sphéricité est raisonnable ; les corrections de Greenhouse–Geisser et Huynh–Feldt confirment la significativité de l’effet de la **période** et de l’interaction **variété × période**, tandis que les termes avec le fertilisant restent non significatifs.

# Vérification des conditions de validité

## Normalité des résidus

```{r normalite, fig.cap="Graphique Q-Q et histogramme des résidus de l’ANOVA à mesures répétées.", error=TRUE}
# On extrait les résidus du modèle sous-jacent (lm) contenu dans l'objet afex
res <- residuals(anova_rm$lm)

# Affichage côte à côte :
# - Q-Q plot : vérification de l'alignement des résidus sur la droite théorique
# - Histogramme : forme globale (approximation gaussienne attendue)
par(mfrow = c(1, 2))
qqnorm(res, main = "Q-Q des résidus"); qqline(res)
hist(res, breaks = 15, main = "Distribution des résidus", xlab = "Résidus")
par(mfrow = c(1, 1))

# Test formel de normalité (Shapiro-Wilk)
shapiro_res <- shapiro.test(res)
shapiro_res
```

Les graphes de résidus indiquent une distribution globalement symétrique et proche d’une droite normale, mais le test de Shapiro–Wilk est significatif (p-value très petite), ce qui met en évidence une déviation statistique de la normalité ; compte tenu de la taille d’échantillon et de l’homogénéité des variances, l’ANOVA reste toutefois utilisable avec prudence.

## Homogénéité des variances (Levene)

Le test de Levene est réalisé sur la **hauteur moyenne par combinaison (id, fertilisant, variete)**, ce qui revient à comparer les variances entre conditions expérimentales (fertilisant × variété), indépendamment de la période.

```{r levene, error=TRUE, warning=FALSE}
# Agrégation : moyenne de hauteur par id, fertilisant, variété
d_mean <- d %>%
  group_by(id, fertilisant, variete) %>%
  summarise(hauteur_moy = mean(hauteur, na.rm = TRUE), .groups = "drop")

# Test de Levene sur les variances de hauteur moyenne entre combinaisons fertilisant × variété
lev <- car::leveneTest(hauteur_moy ~ fertilisant * variete, data = d_mean)

# Mise en forme d'un tableau lisible
lev_df <- as.data.frame(lev)
lev_df <- cbind(Source = rownames(lev_df), lev_df)
rownames(lev_df) <- NULL
names(lev_df) <- c("Source", "Ddl", "F", "p-value")
lev_df[["p-value"]] <- ifelse(is.na(lev_df[["p-value"]]), "—", format.pval(lev_df[["p-value"]], digits = 3))
lev_df[["F"]] <- ifelse(is.na(lev_df[["F"]]), "—", format(round(lev_df[["F"]], 4), nsmall = 4))
lev_df[is.na(lev_df)] <- "—"

knitr::kable(
  lev_df,
  align = c("l", "r", "r", "r"),
  caption = "Test de Levene sur la hauteur moyenne (homogénéité des variances entre groupes de fertilisant et de variété)."
)
```

Le test de Levene n’étant pas significatif, on peut considérer que les variances de hauteur sont similaires entre les combinaisons de fertilisant et de variété.

# Comparaisons post-hoc

# Comparaisons post-hoc

Lorsque des effets ou interactions sont significatifs, les comparaisons deux à deux (Tukey) permettent d’identifier les combinaisons **groupe × variété** et les **périodes** dont les moyennes diffèrent significativement.

## Moyennes marginales (fertilisant × variété)

```{r emm-marginal, error=TRUE}
# Moyennes marginales (effet global de fertilisant × variété, toutes périodes confondues)
emm_gv <- emmeans(anova_rm, ~ fertilisant * variete)

# Extraction sous forme de data.frame et arrondi pour la présentation
emm_gv_df <- summary(emm_gv) %>% as.data.frame()
emm_gv_df <- emm_gv_df %>%
  mutate(
    emmean   = round(emmean, 2),
    SE       = round(SE, 3),
    lower.CL = round(lower.CL, 2),
    upper.CL = round(upper.CL, 2)
  )

names(emm_gv_df) <- c("Fertilisant", "Variété", "Moyenne", "ESM", "Ddl", "IC inf.", "IC sup.")

knitr::kable(
  emm_gv_df[, c("Fertilisant", "Variété", "Moyenne", "ESM", "IC inf.", "IC sup.")],
  align = c("l", "l", "r", "r", "r", "r"),
  caption = "Moyennes marginales (et IC 95 %) pour fertilisant × variété (toutes périodes confondues)."
)
```

Ces moyennes montrent que, en moyenne sur toutes les périodes, la variété 2 produit des plantes plus hautes que la variété 1 pour un même fertilisant, avec des valeurs maximales observées pour les combinaisons `Ca–Var2` et `Ma–Var2`.

## Comparaisons deux à deux : fertilisant × variété (Tukey)

```{r posthoc-gv, error=TRUE}
# Comparaisons toutes paires de combinaisons fertilisant × variété (corrigées de Tukey)
ph_gv <- pairs(emm_gv, adjust = "tukey") %>% as.data.frame()
pval <- ph_gv$p.value

ph_gv <- ph_gv %>%
  mutate(
    estimate = round(estimate, 3),
    SE       = round(SE, 3),
    t.ratio  = round(t.ratio, 2),
    signif   = case_when(
      pval < 0.001 ~ "***",
      pval < 0.01  ~ "**",
      pval < 0.05  ~ "*",
      TRUE         ~ ""
    ),
    p.value = format.pval(p.value, digits = 3, eps = 0.001)
  )

names(ph_gv) <- c("Contraste", "Différence", "ESM", "Ddl", "t", "p-value", "Signif.")

knitr::kable(
  ph_gv,
  align = c("l", "r", "r", "r", "r", "r", "c"),
  caption = "Comparaisons post-hoc Tukey : fertilisant × variété (toutes périodes confondues). * p < 0,05 ; ** p < 0,01 ; *** p < 0,001."
)
```

Après correction de Tukey, seules les combinaisons `Ca–Var2` vs `Ma–Var1` et `Ca–Var2` vs `An–Var1` présentent des différences significatives de hauteur, ce qui confirme un avantage marqué de `Ca–Var2` par rapport à ces deux couples.

## Comparaisons deux à deux par période (Tukey)

```{r posthoc-periode, error=TRUE}
# Effets de fertilisant × variété examinés séparément pour chaque période (T1, T2, T3, T4)
emm_per <- emmeans(anova_rm, ~ fertilisant * variete | periode)
ph_per <- pairs(emm_per, adjust = "tukey") %>% as.data.frame()
pval_per <- ph_per$p.value

ph_per <- ph_per %>%
  mutate(
    estimate = round(estimate, 3),
    SE       = round(SE, 3),
    t.ratio  = round(t.ratio, 2),
    signif   = case_when(
      pval_per < 0.001 ~ "***",
      pval_per < 0.01  ~ "**",
      pval_per < 0.05  ~ "*",
      TRUE             ~ ""
    ),
    p.value = format.pval(p.value, digits = 3, eps = 0.001)
  )

names(ph_per) <- c("Contraste", "Différence", "ESM", "Ddl", "t", "p-value", "Signif.", "Période")

knitr::kable(
  ph_per[, c("Période", "Contraste", "Différence", "ESM", "t", "p-value", "Signif.")],
  align = c("l", "l", "r", "r", "r", "r", "c"),
  caption = "Comparaisons post-hoc Tukey par période. * p < 0,05 ; ** p < 0,01 ; *** p < 0,001."
)
```

À la période T1, plusieurs contrastes sont significatifs et indiquent un net avantage de la variété 2 pour certains fertilisants, alors qu’aux périodes T2, T3 et T4 aucune comparaison fertilisant × variété n’est significative, ce qui suggère un rapprochement des hauteurs entre combinaisons au fil du temps.

# Modèles ANOVA à mesures répétées (structure type DABIRE)

Dans cette section, on implémente **exactement le même type de modèles** que dans le rapport de DABIRE (ANOVA par période, puis ANOVA à mesures répétées avec `car::Anova`), en utilisant directement les variables `fertilisant`, `variete`, `periode` et `hauteur` de la base.

```{r dabire-libs, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(knitr)
if (!requireNamespace("nortest", quietly = TRUE)) install.packages("nortest", repos = "https://cloud.r-project.org", quiet = TRUE)
library(nortest)
library(rstatix)
library(ggpubr)
library(car)
```

```{r dabire-import, error=TRUE}
# Import des mêmes données que précédemment
d2 <- read_excel("donnees/donnees.xlsx")

# Conversion des virgules décimales en points et mise en forme des facteurs
d2$hauteur <- as.numeric(gsub(",", ".", as.character(d2$hauteur)))

d2 <- d2 %>%
  mutate(
    fertilisant = factor(fertilisant),               # Ma, Ca, An
    variete     = factor(variete),                   # Var1, Var2
    periode     = factor(periode, levels = c("T1","T2","T3","T4"))
  )
```

## Modélisation : ANOVA par période + modèle à mesures répétées

```{r dabire-wide, error=TRUE}
# Création d'IDs artificiels par (fertilisant, variete, periode)
d2_id <- d2 %>%
  group_by(fertilisant, variete, periode) %>%
  arrange(No, .by_group = TRUE) %>%
  mutate(rang = row_number()) %>%
  ungroup() %>%
  mutate(id = interaction(fertilisant, variete, rang, drop = TRUE))

# Passage au format large : une ligne = un "sujet", colonnes t1..t4
base <- d2_id %>%
  mutate(
    periode_mesure = dplyr::recode(
      as.character(periode),
      "T1" = "t1",
      "T2" = "t2",
      "T3" = "t3",
      "T4" = "t4"
    )
  ) %>%
  select(id, fertilisant, variete, periode_mesure, hauteur) %>%
  tidyr::pivot_wider(
    names_from  = periode_mesure,
    values_from = hauteur
  ) %>%
  arrange(id)

# Matrice de réponses hauteur (t1..t4) et facteurs
base$hauteur    <- as.matrix(base[, c("t1","t2","t3","t4")])
base$fertilisant <- factor(base$fertilisant)
base$variete     <- factor(base$variete)

attach(base)
```

### 1. Effet du fertilisant à chaque période

```{r dabire-anova-fert, error=TRUE}
mod.hauteur.fertilisant <- lm(hauteur ~ fertilisant)
H_fert <- summary(aov(mod.hauteur.fertilisant))
H_fert

LM_fert <- summary(mod.hauteur.fertilisant)
LM_fert
```

Ces analyses univariées montrent que l’effet du **fertilisant** sur la hauteur n’est significatif qu’à la période T3, où le fertilisant Ca donne des plantes plus hautes que le fertilisant de référence, alors qu’aux périodes T1, T2 et T4 les différences entre fertilisants ne sont pas statistiquement détectables.

### 2. Effet de la variété à chaque période

```{r dabire-anova-var, error=TRUE}
mod.hauteur.variete <- lm(hauteur ~ variete)
H_var <- summary(aov(mod.hauteur.variete))
H_var

LM_var <- summary(mod.hauteur.variete)
LM_var
```

On observe un effet très net de la **variété** à T1, où la variété 2 produit des plantes sensiblement plus hautes que la variété 1, alors qu’aux périodes T2, T3 et T4 les hauteurs des deux variétés deviennent statistiquement similaires.

### 3. Effet d’interaction variété × fertilisant à chaque période

```{r dabire-anova-inter, error=TRUE}
mod.hauteur.interaction <- lm(hauteur ~ variete * fertilisant)
H_int <- summary(aov(mod.hauteur.interaction))
H_int
```

L’interaction **variété × fertilisant** n’est significative à aucune période, ce qui suggère que, à instant donné, l’effet de la variété est globalement parallèle d’un fertilisant à l’autre.

### 4. Modèle global à mesures répétées avec `car::Anova`

```{r dabire-rm, error=TRUE}
fact.temps <- data.frame(TEMPS = as.factor(1:4))

mod.hauteur.tps.interaction <- Anova(
  mod.hauteur.interaction,
  idata   = fact.temps,
  idesign = ~ TEMPS,
  type    = "III",
  test    = "Wilks"
)

summary(mod.hauteur.tps.interaction)
```

Les tests multivariés confirment un effet global du **temps** et une interaction significative **variété × temps**, indiquant que l’écart entre variétés varie au cours des quatre mesures, tandis que les interactions impliquant le fertilisant avec le temps restent non significatives.

# Conclusion

Cette **ANOVA à mesures répétées** (implémentée à la fois avec `afex::aov_car` et avec la structure multivariée de `car::Anova`) permet de tester si les facteurs **terreau** (`groupe` / `fertilisant`), **variété** (`variete`) et **période** (`periode` / `TEMPS`), ainsi que leurs interactions, expliquent la variable dépendante **taille**. Après vérification des hypothèses (normalité des résidus, homogénéité des variances, sphéricité et corrections associées), l’interprétation des effets significatifs et des **comparaisons post-hoc** permet d’identifier les combinaisons terreau × variété et les périodes qui conduisent aux plus fortes hauteurs de plantes.
