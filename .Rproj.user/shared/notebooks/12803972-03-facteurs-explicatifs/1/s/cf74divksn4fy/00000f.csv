"0","# --- Import Excel (prioritaire) ---"
"0","d <- NULL"
"0","if (!is.na(fichier_xlsx)) {"
"0","  tryCatch({"
"0","    if (!requireNamespace(""readxl"", quietly = TRUE)) install.packages(""readxl"", repos = ""https://cloud.r-project.org"", quiet = TRUE)"
"0","    library(readxl)"
"0","    d <- read_excel(fichier_xlsx)"
"0",""
"0","    # Normalisation des noms de colonnes : minuscules, espaces -> _, sans accents"
"0","    noms <- names(d)"
"0","    noms <- tolower(trimws(noms))"
"0","    noms <- gsub(""\\s+"", ""_"", noms)"
"0","    noms <- chartr(""éèêëàâäùûüôöîïç"", ""eeeeaaaauuuooiic"", noms)"
"0","    names(d) <- noms"
"0",""
"0","    # Si format LARGE (colonnes T1, T2, T3, T4) : passage en format long"
"0","    periodes_noms <- grep(""^t[1-4]$"", names(d), value = TRUE)"
"0","    if (length(periodes_noms) >= 2L) {"
"0","      # Construire l'id si absent (colonne locale p, no, etc. ou numéro de ligne)"
"0","      if (!""id"" %in% names(d)) {"
"0","        noms_id_local <- c(""p"", ""id"", ""sujet"", ""subject"", ""no"", ""numero"", ""plant"", ""individu"")"
"0","        candidat <- intersect(noms_id_local, names(d))[1]"
"0","        if (!is.na(candidat)) d$id <- paste0(d$groupe, ""_"", d$variete, ""_"", d[[candidat]])"
"0","        else d$id <- paste0(""S"", row_number())"
"0","      }"
"0","      # Pivot : une ligne par (sujet, période), colonne taille"
"0","      d <- d %>%"
"0","        pivot_longer(all_of(periodes_noms), names_to = ""periode"", values_to = ""taille"") %>%"
"0","        mutate(periode = factor(toupper(periode), levels = paste0(""T"", 1:4)))"
"0","      d <- d %>% filter(!is.na(taille))"
"0","    }"
"0",""
"0","    if (any(names(d) == ""variété"")) names(d)[names(d) == ""variété""] <- ""variete"""
"0","    # Format long sans T1–T4 : id à partir d'une colonne locale si présente"
"0","    if (!""id"" %in% names(d)) {"
"0","      noms_id_local <- c(""p"", ""id"", ""sujet"", ""subject"", ""no"", ""numero"", ""plant"", ""individu"")"
"0","      candidat <- intersect(noms_id_local, names(d))[1]"
"0","      if (!is.na(candidat)) d$id <- paste0(d$groupe, ""_"", d$variete, ""_"", d[[candidat]])"
"0","    }"
"0","  }, error = function(e) d <<- NULL)"
"0","}"
